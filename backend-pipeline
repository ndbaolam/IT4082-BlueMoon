pipeline {
  agent any

  environment {
    IMAGE = "ndbaolam/bluemoon-be"
    TAG = ""
  }

  stages {
    stage('Checkout') {
      steps {
        git url: 'https://github.com/ndbaolam/IT4082-BlueMoon', branch: 'main'
      }
    }

    stage('Check backend changes') {
      steps {
        script {
          def changed = sh(script: "git diff --name-only HEAD~1 HEAD | grep '^backend/' || true", returnStdout: true).trim()
          if (!changed) {
            echo "No changes in backend/, skipping build"
            currentBuild.result = 'SUCCESS'
            currentBuild.description = "No BE changes"
            skipRemainingStages = true
          }
        }
      }
    }

    stage('Get Commit ID') {
      steps {
        script {
          COMMIT_HASH = sh(script: "git rev-parse --short HEAD", returnStdout: true).trim()
          env.TAG = COMMIT_HASH
          echo "Docker tag will be: ${env.TAG}"
        }
      }
    }

    stage('Build & Push Docker Image') {
      when {
        expression { return !binding.hasVariable('skipRemainingStages') }
      }
      steps {
        dir('backend') {
          script {
            withCredentials([usernamePassword(
              credentialsId: 'dockerhubid',
              usernameVariable: 'USER',
              passwordVariable: 'PASS'
            )]) {
              sh """
              docker build -t ${IMAGE}:${TAG} .
              echo "$PASS" | docker login -u "$USER" --password-stdin
              docker push ${IMAGE}:${TAG}
              """
            }
          }
        }
      }
    }
  }
}
